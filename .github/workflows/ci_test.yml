name: ðŸ‚ Continuous integration - Test Suite

on:
  workflow_call:

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
      fail-fast: false

    steps:
      - name: Free up disk space
        if: matrix.platform == 'linux'
        run: |
          echo "=== Before cleanup ==="
          df -h

          # Remove unnecessary tools and files to free up space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc

          # Clean apt cache
          sudo apt-get clean

          echo "=== After cleanup ==="
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy rust-toolchain.toml to root
        if: matrix.platform != 'windows'
        run: |
          cp ${{ github.workspace }}/oxen-rust/rust-toolchain.toml .

      - name: Copy rust-toolchain.toml to root (Windows)
        if: matrix.platform == 'windows'
        run: |
          copy ${{ github.workspace }}\oxen-rust\rust-toolchain.toml .

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.10" # Test against the earliest supported Python version

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          # Only cache builds from main. Otherwise our caches will be too big and start to churn. (10 GB limit in GitHub Actions)
          # Other branches will still use the cache but won't save it.
          save-if: ${{ github.ref == 'refs/heads/main' }}
          workspaces: |
            oxen-rust
            oxen-python

      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew update
          brew install ffmpeg imagemagick redis
          brew services start redis

      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libavcodec-dev libavformat-dev libavfilter-dev libavdevice-dev libavutil-dev pkg-config

      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows'
        run: |
          echo "=== Before installing dependencies ==="
          Get-PSDrive -PSProvider FileSystem | Format-Table Name, @{Label="Used(GB)";Expression={[math]::Round($_.Used/1GB,2)}}, @{Label="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}, @{Label="Total(GB)";Expression={[math]::Round(($_.Used+$_.Free)/1GB,2)}}
          
          # Install vcpkg for FFmpeg development libraries
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg.exe install ffmpeg:x64-windows
          # Set VCPKG_ROOT for cargo to find FFmpeg libraries
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          
          echo "=== After installing dependencies ==="
          Get-PSDrive -PSProvider FileSystem | Format-Table Name, @{Label="Used(GB)";Expression={[math]::Round($_.Used/1GB,2)}}, @{Label="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}, @{Label="Total(GB)";Expression={[math]::Round(($_.Used+$_.Free)/1GB,2)}}

      - name: Install nextest runner
        uses: taiki-e/install-action@nextest

      # Oxen Rust Tests
      - name: Setup test directories (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd ${{ github.workspace }}/oxen-rust
          mkdir -p data/test/runs
          mkdir -p /tmp/oxen_sync/

      - name: Setup test directories (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd ${{ github.workspace }}\oxen-rust
          mkdir .\data\test\runs

      - name: Build oxen-rust
        run: |
          cd ${{ github.workspace }}/oxen-rust
          cargo build

      - name: Setup oxen-server user (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd ${{ github.workspace }}/oxen-rust
          ./target/debug/oxen-server add-user --email ox@oxen.ai --name Ox --output user_config.toml
          cp user_config.toml data/test/config/user_config.toml

      - name: Setup oxen-server user (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd ${{ github.workspace }}\oxen-rust
          .\target\debug\oxen-server add-user --email ox@oxen.ai --name Ox --output user_config.toml
          copy user_config.toml data\test\config\user_config.toml

      - name: Run oxen-rust tests (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd ${{ github.workspace }}/oxen-rust
          ./target/debug/oxen-server start &
          cargo nextest run --profile ci

      - name: Run oxen-rust tests (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd ${{ github.workspace }}\oxen-rust
          Start-Process -FilePath "${{ github.workspace }}\oxen-rust\target\debug\oxen-server.exe" -WindowStyle Hidden -ArgumentList "start"
          cargo nextest run --profile ci

      # CLI Tests
      - name: Run CLI tests (Linux/macOS)
        if: matrix.platform != 'windows'
        env:
          PATH: ${{ env.PATH }}:${{ github.workspace }}/oxen-rust/target/debug
        run: |
          cd ${{ github.workspace }}/oxen-rust/cli-test
          uv sync
          uv run pytest tests -v

      - name: Run CLI tests (Windows)
        if: matrix.platform == 'windows'
        env:
          PATH: ${{ env.PATH }};${{ github.workspace }}/oxen-rust/target/debug
        run: |
          cd ${{ github.workspace }}\oxen-rust\cli-test
          uv sync
          uv run pytest tests -v

      # Oxen Python Tests
      - name: Copy binaries for Python tests (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cp ${{ github.workspace }}/oxen-rust/target/debug/oxen ~/oxen
          chmod +x ~/oxen ~/oxen

      - name: Copy binaries for Python tests (Windows)
        if: matrix.platform == 'windows'
        run: |
          copy oxen-rust\target\debug\oxen.exe ${{ github.workspace }}\oxen.exe

      - name: Run oxen-python tests (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd ${{ github.workspace }}/oxen-python

          ~/oxen config --name "Bessie Testington" --email "bessie@yourcompany.com"

          uv sync --no-install-project
          source .venv/bin/activate
          maturin develop
          pytest -s tests

      - name: Run oxen-python tests (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd ${{ github.workspace }}\oxen-python

          ${{ github.workspace }}\oxen.exe config --name "Bessie Testington" --email "bessie@yourcompany.com"

          uv sync --no-install-project
          dir .venv
          .venv\Scripts\Activate.ps1
          maturin develop
          pytest -s tests --ignore=tests/test_data_frame.py --ignore=tests/test_embeddings.py --ignore=tests/test_fsspec_backend.py
